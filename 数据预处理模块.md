# 数据预处理模块

## 2026年MCM问题C：与星共舞（Dancing with the Stars）数据预处理方案

---

## 一、数据预处理总览

本模块针对《与星共舞》比赛数据进行系统的预处理工作，为后续四个核心问题的建模分析奠定数据基础。

### 1.1 预处理流程框架

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        数据预处理总体流程                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        ▼                           ▼                           ▼
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│   数据质量评估     │     │     数据清洗      │     │    特征工程       │
│ ├─缺失值检测       │     │ ├─N/A值处理       │     │ ├─评分特征提取    │
│ ├─异常值检测       │     │ ├─数据类型转换    │     │ ├─类别特征编码    │
│ ├─重复值检测       │     │ ├─地区缺失值填充  │     │ ├─趋势特征计算    │
│ └─数据类型分析     │     │ └─赛季规则标记    │     │ └─结果特征解析    │
└─────────┬─────────┘     └─────────┬─────────┘     └─────────┬─────────┘
          │                         │                         │
          └─────────────────────────┼─────────────────────────┘
                                    ▼
                    ┌───────────────────────────────┐
                    │       数据可视化分析          │
                    │ ├─缺失值热力图                │
                    │ ├─评分分布图                  │
                    │ ├─特征相关性分析              │
                    │ └─异常值检测可视化            │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
            ┌───────────┐   ┌───────────┐   ┌───────────┐
            │ 问题1数据  │   │ 问题2数据  │   │ 问题3/4数据│
            │ (投票估算) │   │ (方法对比) │   │ (特征分析) │
            └───────────┘   └───────────┘   └───────────┘
```

### 1.2 数据集概况

| 数据集 | 记录数 | 字段数 | 主要内容 | 处理后字段数 |
|--------|-------|-------|----------|-------------|
| 核心数据(数据.csv) | 421 | 53 | 选手信息、各周评委评分、比赛结果 | 97 |
| 补充数据(补充数据.xlsx) | 421 | 11 | 社交媒体粉丝数据 | 21 |

---

## 二、数据质量评估

### 2.1 缺失值分析

#### 2.1.1 核心数据缺失值情况

| 缺失值类型 | 涉及列数 | 主要来源 | 业务含义 |
|-----------|---------|---------|---------|
| N/A字符串 | 11列 | week*_judge4_score列 | 该周仅有3位评委评分，第4评委未参与 |
| 空值(null) | 1列 | celebrity_homestate | 非美国选手的家乡州信息缺失 |
| 0值 | 44列 | 所有评分列 | 选手在该周已被淘汰，不参与评分 |

**具体缺失情况统计：**

| 字段 | 缺失数量 | 缺失比例 | 处理方式 |
|-----|---------|---------|---------|
| celebrity_homestate | 56 | 13.3% | 用"Unknown"填充 |
| week*_judge4_score | 285-340 | 67.7%-80.8% | 转换为np.nan，计算时排除 |

**判断依据：**
- judge4评分的高缺失率符合题目说明：早期赛季仅有3位评委
- 0值代表已淘汰选手，属于有效业务数据，应予保留
- 地区缺失主要为非美国选手，符合数据来源特点

#### 2.1.2 补充数据缺失值情况

| 字段 | 有效值数量 | 覆盖率 | 说明 |
|-----|-----------|--------|------|
| celebrity_twitter_followers | 278 | 66.0% | 主要数据来源 |
| celebrity_total_followers_wikidata | 282 | 67.0% | 综合粉丝数 |
| partner_twitter_followers | 233 | 55.3% | 舞伴数据 |
| celebrity_instagram_followers | 6 | 1.4% | 覆盖率极低 |
| celebrity_tiktok_followers | 2 | 0.5% | 覆盖率极低 |

**处理建议：** 补充数据仅作为问题3的辅助特征使用，需注意其局限性。

### 2.2 异常值检测

采用**IQR方法**（四分位距法）进行异常值检测：
- 下界：Q1 - 1.5 × IQR
- 上界：Q3 + 1.5 × IQR

**检测结果：**

| 字段 | 异常值数量 | 异常值比例 | 处理决策 | 理由 |
|-----|-----------|-----------|---------|------|
| celebrity_age_during_season | 7 | 1.66% | 保留 | 高龄选手（如82岁的Cloris Leachman）属于真实数据 |
| week1_judge1_score | 33 | 7.84% | 保留 | 评分异常值反映选手表现差异，属于有效数据 |
| week1_judge2_score | 3 | 0.71% | 保留 | 同上 |

**处理策略：** 
- 所有检测到的"异常值"均属于正常业务数据范围
- 不进行删除或修正，保留原始数据的完整性
- 在后续建模中，可考虑使用鲁棒方法处理极端值影响

### 2.3 重复值检测

| 数据集 | 重复行数 | 处理方式 |
|-------|---------|---------|
| 核心数据 | 0 | 无需处理 |
| 补充数据 | 5 | 保留（同名选手参加多季情况） |

### 2.4 数据类型分析

**核心数据类型分布：**

| 数据类型 | 列数 | 示例字段 |
|---------|-----|---------|
| 字符串(str) | 6 | celebrity_name, celebrity_industry, results |
| 整数(int64) | 3 | season, placement |
| 浮点数(float64) | 44 | 所有评分列、年龄 |

**数据类型问题及处理：**
- 评分列中的"N/A"字符串 → 转换为np.nan（浮点数空值）
- 年龄字段已为数值型，无需额外处理
- 类别字段保持字符串类型，后续通过编码转换

---

## 三、数据清洗

### 3.1 缺失值处理方法

| 字段类型 | 处理方法 | 选择依据 |
|---------|---------|---------|
| 评分列(数值型) | N/A → np.nan | 便于后续数值计算时自动排除 |
| 地区字段(分类型) | 空值 → "Unknown" | 保持类别完整性，便于编码 |
| 0值(评分列) | 保留原值 | 0值代表"已淘汰"状态，是有效业务标记 |

**处理代码逻辑：**
```python
# N/A字符串处理
df_cleaned.loc[df_cleaned[col] == 'N/A', col] = np.nan

# 地区缺失值填充
df_cleaned['celebrity_homestate'].fillna('Unknown')

# 评分列数值化
df_cleaned[col] = pd.to_numeric(df_cleaned[col], errors='coerce')
```

### 3.2 赛季规则标记

根据题目描述，比赛规则在不同赛季有所变化：

| 赛季范围 | 规则类型 | 规则说明 | 记录数 |
|---------|---------|---------|-------|
| 1-2季 | Ranking | 基于排名合并评委评分和粉丝投票 | 16 |
| 3-27季 | Percentage | 基于百分比合并评委评分和粉丝投票 | 306 |
| 28-34季 | Ranking_JudgeSave | 排名法+评委决定淘汰（两人垫底时由评委投票） | 99 |

**标记逻辑：**
```python
def get_season_rule(season):
    if season <= 2:
        return 'Ranking'
    elif season <= 27:
        return 'Percentage'
    else:
        return 'Ranking_JudgeSave'
```

### 3.3 数据类型转换汇总

| 原始字段 | 原始类型 | 转换后类型 | 处理方式 |
|---------|---------|-----------|---------|
| week*_judge*_score | object (含N/A) | float64 | pd.to_numeric转换 |
| celebrity_age_during_season | float64 | float64 | 保持，仅验证范围 |
| season | int64 | int64 | 保持 |
| placement | int64 | int64 | 保持 |

---

## 四、特征工程

### 4.1 特征筛选与提取

#### 4.1.1 评分特征提取

| 新特征名称 | 计算方法 | 业务含义 | 应用问题 |
|-----------|---------|---------|---------|
| week{n}_total_score | 各评委评分之和 | 单周总评分 | 问题1、2 |
| week{n}_avg_score | 各评委评分均值 | 单周平均评分 | 问题1、2、3 |
| week{n}_judge_count | 非空评委数量 | 有效评委人数 | 辅助分析 |
| cumulative_total_score | 所有周总分之和 | 累积总评分 | 问题2、3 |
| overall_avg_score | 所有周平均分均值 | 整体平均水平 | 问题3 |
| score_trend | 线性回归斜率 | 评分上升/下降趋势 | 问题3 |
| active_weeks | 有效参赛周数 | 选手持续时间 | 问题3 |

**评分趋势计算方法：**
```python
def calculate_trend(row):
    """计算选手评分的线性趋势斜率"""
    scores = []
    weeks = []
    for week in range(1, 12):
        score = row[f'week{week}_avg_score']
        if pd.notna(score) and score > 0:
            scores.append(score)
            weeks.append(week)
    
    if len(scores) >= 2:
        slope, _, _, _, _ = stats.linregress(weeks, scores)
        return slope
    return 0
```

#### 4.1.2 结果特征解析

从`results`字段解析以下特征：

| 新特征名称 | 数据类型 | 取值说明 |
|-----------|---------|---------|
| is_winner | bool | True=冠军, False=非冠军 |
| eliminated_week | int/None | 被淘汰的周数，决赛选手为None |
| final_rank | int/None | 最终排名（1/2/3），仅前三名有值 |

**解析逻辑：**
- "1st Place" → is_winner=True, final_rank=1
- "2nd Place" → final_rank=2
- "Eliminated Week X" → eliminated_week=X
- "Withdrew" → eliminated_week=-1（特殊标记）

### 4.2 特征转换

#### 4.2.1 类别特征编码

| 原始字段 | 编码方法 | 编码后字段 | 类别数 |
|---------|---------|-----------|-------|
| celebrity_industry | LabelEncoder | industry_encoded | 26 |
| celebrity_homecountry/region | LabelEncoder | country_encoded | 23 |
| season_rule | 手动映射 | season_rule_encoded | 3 |

**选择Label Encoding的理由：**
- 类别数量较多（26个行业），One-Hot编码会产生高维稀疏矩阵
- 后续主要使用树模型（随机森林、XGBoost），可直接处理Label编码
- 对于线性模型，可在需要时再转换为One-Hot编码

#### 4.2.2 赛季规则编码映射

| 原始值 | 编码值 | 说明 |
|-------|-------|------|
| Ranking | 0 | 排名法（1-2季） |
| Percentage | 1 | 百分比法（3-27季） |
| Ranking_JudgeSave | 2 | 排名法+评委决定（28-34季） |

### 4.3 特征工程后数据维度

| 阶段 | 字段数 | 新增/变化说明 |
|-----|-------|--------------|
| 原始数据 | 53 | - |
| 数据清洗后 | 54 | +1: season_rule |
| 特征工程后 | 97 | +43: 评分特征、编码特征、解析特征等 |

### 4.4 特征相关性分析

基于Pearson相关系数的特征相关性分析结果：

| 特征对 | 相关系数 | 相关性说明 |
|-------|---------|-----------|
| cumulative_total_score ↔ overall_avg_score | 0.89 | 强正相关，可选择其一 |
| cumulative_total_score ↔ active_weeks | 0.81 | 强正相关，参与时间越长累积分越高 |
| overall_avg_score ↔ placement | -0.58 | 中等负相关，平均分越高排名越靠前 |
| score_trend ↔ placement | -0.23 | 弱负相关，评分上升趋势有助于更好排名 |

**处理建议：** 
- cumulative_total_score和active_weeks存在多重共线性，建模时可考虑特征选择
- 特征相关性热力图已生成（见output/06_correlation_heatmap.png）

---

## 五、数据可视化分析

### 5.1 可视化图表清单

| 序号 | 图表名称 | 文件名 | 分析目的 |
|-----|---------|--------|---------|
| 1 | 缺失值热力图 | 01_missing_values_heatmap.png | 展示清洗前后缺失值分布变化 |
| 2 | 评分分布图 | 02_score_distribution.png | 分析各周评分的分布特征 |
| 3 | 赛季分布图 | 03_season_distribution.png | 展示各赛季参赛人数和规则分布 |
| 4 | 行业分布图 | 04_industry_distribution.png | 分析选手行业构成 |
| 5 | 年龄分布图 | 05_age_distribution.png | 分析年龄分布及与排名关系 |
| 6 | 特征相关性热力图 | 06_correlation_heatmap.png | 展示数值特征间的相关关系 |
| 7 | 评分趋势案例图 | 07_score_trends_cases.png | 展示典型/争议案例的评分变化 |
| 8 | 异常值检测图 | 08_outlier_detection.png | 可视化异常值检测结果 |

### 5.2 关键可视化发现

#### 5.2.1 赛季分布特征
- 早期赛季（1-10季）每季约12-16人参赛
- 近期赛季（28-34季）每季约13-17人参赛
- 三种规则的数据分布：Percentage(72.7%) > Ranking_JudgeSave(23.5%) > Ranking(3.8%)

#### 5.2.2 行业分布特征
- Actor/Actress占比最高（约35%）
- Athlete、Singer/Rapper次之
- TV Personality、Model等也有较多代表

#### 5.2.3 年龄分布特征
- 平均年龄：38.8岁
- 年龄范围：14-82岁
- 冠军选手年龄与整体分布无显著差异

#### 5.2.4 争议案例评分趋势
- Jerry Rice（S2）：评分持续偏低但获得亚军
- Bristol Palin（S11）：多周评委最低分仍获第三名
- Bobby Bones（S27）：评分一直较低却获得冠军

---

## 六、模型专用数据准备

### 6.1 问题1专用数据集

**用途：** 粉丝投票估算模型

**包含字段：**
- 标识信息：celebrity_name, season, season_rule
- 结果信息：placement, results
- 评分信息：week1-11_judge1-4_score（原始评分）
- 衍生评分：week1-11_total_score

**数据维度：** 421行 × 60列

### 6.2 问题2专用数据集

**用途：** 投票合并方法对比分析

**包含字段：**
- 标识信息：celebrity_name, season, season_rule
- 结果信息：placement, results
- 评分特征：cumulative_total_score, overall_avg_score
- 各周评分：week1-11_total_score, week1-11_avg_score

**数据维度：** 421行 × 29列

### 6.3 问题3专用数据集

**用途：** 名人特征影响分析

**包含字段：**
- 个人信息：celebrity_name, ballroom_partner
- 特征信息：celebrity_industry, celebrity_homestate, celebrity_homecountry/region, celebrity_age_during_season
- 编码特征：industry_encoded, country_encoded
- 评分特征：cumulative_total_score, overall_avg_score, score_trend
- 结果特征：placement, is_winner, final_rank, active_weeks

**数据维度：** 421行 × 16列

### 6.4 问题4专用数据集

**用途：** 新投票系统设计

**包含字段：** 全部97个字段（完整处理后数据）

**数据维度：** 421行 × 97列

---

## 七、数据划分说明

### 7.1 划分策略

本题数据具有以下特点，需要特殊的划分策略：

| 特点 | 说明 | 划分策略 |
|-----|------|---------|
| 时序依赖性 | 赛季间规则变化 | 按赛季分组，不随机打乱 |
| 规则差异 | 三种不同的评分合并规则 | 按规则类型分层划分 |
| 样本量限制 | 总样本421条 | 采用交叉验证而非固定划分 |

### 7.2 推荐划分方案

**方案1：按赛季规则分层交叉验证**
```
Ranking (16条) → 5折交叉验证
Percentage (306条) → 5折交叉验证  
Ranking_JudgeSave (99条) → 5折交叉验证
```

**方案2：时序划分（用于验证模型泛化能力）**
```
训练集：Season 1-27 (322条, 76.5%)
测试集：Season 28-34 (99条, 23.5%)
```

**选择依据：**
- 方案1适用于问题1、3的建模，充分利用各规则类型数据
- 方案2适用于问题4的系统验证，测试新规则下的效果

### 7.3 数据泄露防范

| 潜在风险 | 防范措施 |
|---------|---------|
| 未来信息泄露 | 按赛季顺序划分，不将后期数据用于训练 |
| 选手重复 | 检查同名选手跨季情况，确保不出现在训练和测试集 |
| 舞伴信息 | 舞伴可能参加多季，注意按舞伴分组 |

---

## 八、数据预处理结论

### 8.1 数据质量总结

| 评估维度 | 评估结果 | 质量评级 |
|---------|---------|---------|
| 完整性 | 核心字段完整，评分列N/A可理解 | ★★★★☆ |
| 准确性 | 无明显错误数据 | ★★★★★ |
| 一致性 | 字段格式统一 | ★★★★★ |
| 时效性 | 覆盖1-34季完整数据 | ★★★★★ |
| 适用性 | 满足四个问题建模需求 | ★★★★★ |

### 8.2 特征工程总结

| 特征类型 | 新增数量 | 主要特征 |
|---------|---------|---------|
| 评分统计特征 | 33 | total_score, avg_score, judge_count |
| 累积/趋势特征 | 4 | cumulative, overall_avg, score_trend, active_weeks |
| 结果解析特征 | 3 | is_winner, eliminated_week, final_rank |
| 编码特征 | 3 | industry_encoded, country_encoded, season_rule_encoded |

### 8.3 输出文件清单

| 文件名 | 类型 | 内容说明 |
|-------|------|---------|
| processed_main_data.csv | 数据 | 处理后的核心数据（421×97） |
| processed_supplementary_data.csv | 数据 | 处理后的补充数据（421×21） |
| question1_data.csv | 数据 | 问题1专用数据集 |
| question2_data.csv | 数据 | 问题2专用数据集 |
| question3_data.csv | 数据 | 问题3专用数据集 |
| question4_data.csv | 数据 | 问题4专用数据集 |
| data_dictionary.csv | 元数据 | 字段说明字典 |
| 01-08_*.png | 图表 | 8张可视化分析图 |
| preprocessing_report.md | 报告 | 预处理摘要报告 |

### 8.4 后续建模建议

1. **问题1建模输入**：使用question1_data.csv，关注评分列的0值处理（标记为非参与状态）
2. **问题2分析输入**：使用question2_data.csv，按season_rule分组进行方法对比
3. **问题3特征选择**：使用question3_data.csv，注意高相关特征的共线性处理
4. **问题4系统验证**：使用question4_data.csv，基于历史数据回测新系统效果

---

## 九、代码文件说明

### 9.1 主程序文件

**文件名：** `data_preprocessing.py`

**功能模块：**
1. 数据加载模块：load_data()
2. 质量评估模块：assess_data_quality(), assess_score_columns()
3. 数据清洗模块：clean_main_data(), clean_supplementary_data()
4. 特征工程模块：engineer_features()
5. 模型数据准备：prepare_model_data()
6. 可视化模块：visualize_data_quality()
7. 数据导出模块：export_data()
8. 报告生成模块：generate_report()

### 9.2 运行方式

```bash
cd /home/runner/work/D/D
python3 data_preprocessing.py
```

### 9.3 输出目录

所有处理结果保存在 `/home/runner/work/D/D/output/` 目录下。

---

**文档生成时间：** 2026年MCM竞赛

**适用对象：** 2026年MCM C题参赛团队

**文档版本：** v1.0
